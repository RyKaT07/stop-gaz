- name: Determine project root (parent of ansible directory)
  set_fact:
    project_root: "{{ playbook_dir | dirname }}"

- name: Determine control user
  set_fact:
    control_user: "{{ lookup('env', 'SUDO_USER') | default(lookup('env', 'USER'), true) }}"
  become: false

- name: Check for existing node_modules directory
  stat:
    path: "{{ project_root }}/web/node_modules"
  register: web_node_modules
  become: false

- name: Fix node_modules ownership for current user
  file:
    path: "{{ project_root }}/web/node_modules"
    owner: "{{ control_user }}"
    group: "{{ control_user }}"
    recurse: true
  when: web_node_modules.stat.isdir | default(false)
  become: true

- name: Install web dependencies (npm ci)
  command: npm ci
  args:
    chdir: "{{ project_root }}/web"
  environment:
    NODE_ENV: development
  become: false

- name: Clean previous Next.js build artifacts
  file:
    path: "{{ project_root }}/web/.next"
    state: absent
  become: true

- name: Build web dashboard
  command: npm run build
  args:
    chdir: "{{ project_root }}/web"
  become: false

- name: Ensure mosquitto directories exist with proper ownership
  file:
    path: "{{ mosquitto_dest }}/mosquitto/{{ item.name }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - { name: config, owner: root, group: root, mode: '0755' }
    - { name: data, owner: '1883', group: '1883', mode: '0770' }
    - { name: log, owner: '1883', group: '1883', mode: '0770' }

- name: Copy mosquitto config files
  copy:
    src: "{{ project_root }}/mosquitto/config/"
    dest: "{{ mosquitto_dest }}/mosquitto/config/"
    owner: root
    group: root
    mode: '0644'
    directory_mode: '0755'

- name: Copy aggregator service files
  copy:
    src: "{{ project_root }}/aggregator/"
    dest: "{{ mosquitto_dest }}/aggregator/"
    owner: root
    group: root
    mode: '0644'
    directory_mode: '0755'

- name: Reset web directory on target
  file:
    path: "{{ mosquitto_dest }}/web"
    state: absent

- name: Ensure web directories exist
  file:
    path: "{{ mosquitto_dest }}/web/{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - .
    - .next
    - public

- name: Copy Next.js build output
  copy:
    src: "{{ project_root }}/web/.next/"
    dest: "{{ mosquitto_dest }}/web/.next/"
    owner: root
    group: root
    mode: '0644'
    directory_mode: '0755'

- name: Copy public assets
  copy:
    src: "{{ project_root }}/web/public/"
    dest: "{{ mosquitto_dest }}/web/public/"
    owner: root
    group: root
    mode: '0644'
    directory_mode: '0755'

- name: Copy web runtime files
  copy:
    src: "{{ project_root }}/web/{{ item }}"
    dest: "{{ mosquitto_dest }}/web/{{ item }}"
    owner: root
    group: root
    mode: '0644'
  loop:
    - package.json
    - package-lock.json
    - next.config.mjs
    - Dockerfile

- name: Copy docker-compose file
  copy:
    src: "{{ project_root }}/docker-compose.yml"
    dest: "{{ mosquitto_dest }}/docker-compose.yml"
    owner: root
    group: root
    mode: '0644'

- name: Copy scripts directory
  copy:
    src: "{{ project_root }}/scripts/"
    dest: "{{ mosquitto_dest }}/scripts/"
    owner: root
    group: root
    mode: '0755'

- name: Ensure generate certs script is executable
  file:
    path: "{{ mosquitto_dest }}/scripts/mosquitto-generate-certs.sh"
    mode: '0755'
    state: file
  when: mosquitto_enable_tls | default(false)

- name: Generate TLS certs if missing
  command: "{{ mosquitto_dest }}/scripts/mosquitto-generate-certs.sh {{ mosquitto_dest }}/mosquitto/certs"
  args:
    creates: "{{ mosquitto_dest }}/mosquitto/certs/ca.crt"
  when: mosquitto_enable_tls | default(false)

- name: Create passwordfile and add users
  block:
    - name: Ensure passwordfile exists
      file:
        path: "{{ mosquitto_dest }}/mosquitto/config/passwordfile"
        state: touch
        mode: '0600'

    - name: Add mosquitto users using docker mosquitto_passwd
      loop: "{{ mosquitto_users }}"
      vars:
        user_item: "{{ item }}"
      command: >-
        docker run --rm -v {{ mosquitto_dest }}/mosquitto/config:/mosquitto/config
        eclipse-mosquitto:2 mosquitto_passwd -b /mosquitto/config/passwordfile
        {{ user_item.name }} {{ user_item.password }}

- name: Launch mosquitto stack
  command: docker compose -f "{{ mosquitto_dest }}/docker-compose.yml" up -d --build
  args:
    chdir: "{{ mosquitto_dest }}"
